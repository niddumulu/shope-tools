<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Baca CSV Shopee + Sortir + Link Mode</title>
<style>
  body {
    font-family: Arial, sans-serif;
    margin: 20px;
    max-width: 950px;
    margin-left: auto;
    margin-right: auto;
  }
  h2 { text-align: center; }
  .menu-bar {
    display: flex;
    align-items: center;
    justify-content: space-between;
    flex-wrap: wrap;
    gap: 8px;
    margin-bottom: 15px;
    background: #f9f9f9;
    padding: 10px;
    border-radius: 8px;
    border: 1px solid #ddd;
  }
  .buttons {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
  }
  button {
    padding: 8px 14px;
    border: none;
    background: #007bff;
    color: white;
    border-radius: 6px;
    cursor: pointer;
  }
  button:hover { background: #0056b3; }
  input[type="file"] { padding: 4px; }
  label { cursor: pointer; }
  #headers {
    border: 1px solid #ccc;
    border-radius: 6px;
    padding: 10px;
    margin-top: 10px;
    background: #fdfdfd;
    width: fit-content;
  }
  #headers label {
    display: flex;
    align-items: center;
    gap: 6px;
    padding: 3px 0;
  }
  table {
    border-collapse: collapse;
    width: 100%;
    margin-top: 15px;
  }
  th, td {
    border: 1px solid #aaa;
    padding: 8px;
    text-align: left;
  }
  th { background: #eee; }
  tr:nth-child(even) { background: #fafafa; }
  #links a {
    display: block;
    margin: 2px 0;
    color: #007bff;
    text-decoration: none;
  }
  #links a:hover { text-decoration: underline; }
  .hidden { display: none; }
</style>
</head>
<body>

<h2>Baca File CSV Shopee</h2>

<div class="menu-bar">
  <input type="file" id="csvFile" accept=".csv">
  <div class="buttons" id="menuButtons">
    <button id="toggleHeaders">Pilih Kolom</button>
    <button id="showData">Tampilkan Data</button>
    <button id="toggleTable">Sembunyikan Hasil</button>
    <button id="generateLinks">Generate Link</button>
    <button id="toggleLinks">Lihat Link</button>
    <button id="copyLinks">Salin Semua Link</button>
  </div>
  <label><input type="checkbox" id="modeLinkSaja"> Mode Link Saja</label>
</div>

<div id="headers" class="hidden"></div>
<div id="output" class="hidden"></div>
<div id="links" class="hidden"></div>

<script>
let csvData = [];
let headers = [];

document.getElementById('csvFile').addEventListener('change', handleFile);
document.getElementById('toggleHeaders').addEventListener('click', () => {
  document.getElementById('headers').classList.toggle('hidden');
});
document.getElementById('showData').addEventListener('click', showFilteredData);
document.getElementById('generateLinks').addEventListener('click', generateLinks);
document.getElementById('toggleLinks').addEventListener('click', () => {
  document.getElementById('links').classList.toggle('hidden');
});
document.getElementById('copyLinks').addEventListener('click', copyAllLinks);
document.getElementById('toggleTable').addEventListener('click', toggleTable);
document.getElementById('modeLinkSaja').addEventListener('change', toggleModeLinkSaja);

window.addEventListener('load', () => {
  const savedMode = localStorage.getItem('modeLinkSaja');
  if (savedMode === 'true') {
    document.getElementById('modeLinkSaja').checked = true;
    toggleModeLinkSaja();
  }
});

function handleFile(event) {
  const file = event.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = function(e) {
    const text = e.target.result;
    const rows = text.split('\n').filter(r => r.trim() !== '');
    headers = rows[0].split(',').map(h => h.trim());
    csvData = rows.slice(1).map(row => row.split(',').map(c => c.trim()));
    showHeaders();
    document.getElementById('menuButtons').classList.remove('hidden');
  };
  reader.readAsText(file);
}

function showHeaders() {
  const container = document.getElementById('headers');
  container.innerHTML = '<b>Pilih Kolom:</b><br><br>';
  headers.forEach((h, i) => {
    const checked = ['ID Shop','ID Barang','Total Komisi per Produk(Rp)'].includes(h);
    container.innerHTML += `<label><input type="checkbox" id="chk${i}" ${checked ? 'checked' : ''}> ${i+1}. ${h}</label>`;
  });
  container.classList.remove('hidden');
}

function showFilteredData() {
  const selectedIndexes = headers.map((_, i) => document.getElementById('chk' + i)?.checked ? i : null).filter(i => i !== null);
  const table = document.createElement('table');
  const headerRow = document.createElement('tr');
  selectedIndexes.forEach(i => {
    const th = document.createElement('th');
    th.textContent = headers[i];
    headerRow.appendChild(th);
  });
  table.appendChild(headerRow);
  let filtered = csvData.slice().sort((a, b) => {
    const idx = headers.indexOf('Total Komisi per Produk(Rp)');
    const valA = parseInt(a[idx]?.replace(/[^\d]/g, '') || '0');
    const valB = parseInt(b[idx]?.replace(/[^\d]/g, '') || '0');
    return valB - valA;
  });
  filtered.forEach(row => {
    const tr = document.createElement('tr');
    selectedIndexes.forEach(i => {
      const td = document.createElement('td');
      td.textContent = row[i];
      tr.appendChild(td);
    });
    table.appendChild(tr);
  });
  const output = document.getElementById('output');
  output.innerHTML = '';
  output.appendChild(table);
  output.classList.remove('hidden');
}

function toggleTable() {
  const table = document.getElementById('output');
  const hidden = table.classList.toggle('hidden');
  document.getElementById('toggleTable').textContent = hidden ? 'Tampilkan Hasil' : 'Sembunyikan Hasil';
}

function generateLinks() {
  const idShopIdx = headers.indexOf('ID Shop');
  const idBarangIdx = headers.indexOf('ID Barang');
  const linksDiv = document.getElementById('links');
  linksDiv.innerHTML = '';
  let sorted = csvData.slice().sort((a, b) => {
    const idx = headers.indexOf('Total Komisi per Produk(Rp)');
    const valA = parseInt(a[idx]?.replace(/[^\d]/g, '') || '0');
    const valB = parseInt(b[idx]?.replace(/[^\d]/g, '') || '0');
    return valB - valA;
  });
  sorted.forEach(row => {
    const link = `https://shopee.co.id/product/${row[idShopIdx]}/${row[idBarangIdx]}`;
    const a = document.createElement('a');
    a.href = link;
    a.textContent = link;
    a.target = '_blank';
    linksDiv.appendChild(a);
  });
  linksDiv.classList.remove('hidden');
}

function copyAllLinks() {
  const links = Array.from(document.querySelectorAll('#links a')).map(a => a.href).join('\n');
  navigator.clipboard.writeText(links);
  alert('Semua link berhasil disalin!');
}

function toggleModeLinkSaja() {
  const mode = document.getElementById('modeLinkSaja').checked;
  const menuButtons = document.getElementById('menuButtons');
  const csvFile = document.getElementById('csvFile');
  localStorage.setItem('modeLinkSaja', mode);
  if (mode) {
    menuButtons.classList.add('hidden');
    document.getElementById('headers').classList.add('hidden');
    document.getElementById('output').classList.add('hidden');
    generateLinks();
    document.getElementById('links').classList.remove('hidden');
  } else {
    menuButtons.classList.remove('hidden');
  }
}
</script>

</body>
</html>
