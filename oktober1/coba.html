<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Link Shopee Pagination</title>
<style>
  body { font-family: Arial, sans-serif; margin: 15px; max-width: 700px; margin-left:auto; margin-right:auto; }
  h2,h3 { font-size: 1.2rem; margin-bottom: 8px; }
  textarea { width:100%; height:150px; box-sizing:border-box; font-size:1rem; padding:8px; border-radius:6px; border:1px solid #ccc; }
  #output { margin-top:10px; }
  #output a { display:block; margin-bottom:6px; color:#0066cc; text-decoration:none; word-wrap:break-word; }
  #output a:hover { text-decoration:underline; }
  .pagination { margin-top:15px; text-align:center; display:flex; flex-wrap:wrap; gap:6px; justify-content:center; }
  .page-btn { padding:10px 14px; cursor:pointer; border:1px solid #ccc; border-radius:6px; background-color:white; font-size:1rem; min-width:40px; }
  .page-btn:hover { background-color:#ffd42a; color:#b36b00; }
  .active { font-weight:bold; background-color:#ffd42a; color:#b36b00; border-color:#b36b00; }
  #copyBtn { margin-top:12px; padding:12px; font-size:1rem; cursor:pointer; border:none; background-color:#ffd42a; color:#b36b00; border-radius:6px; width:100%; }
  #copyBtn:hover { background-color:#e6c72b; }
  .input-buttons { display:flex; gap:8px; margin-top:6px; flex-wrap:wrap; }
  .input-buttons button { flex:1; padding:10px; font-size:0.95rem; cursor:pointer; border:1px solid #ccc; border-radius:6px; background:#f5f5f5; }
  .input-buttons button:hover { background:#eee; }
  #stats { margin:15px 0; font-weight:bold; font-size:1rem; white-space:pre-line; }
  .sponsor { background-color:#fffae6; border:1px solid #ffd42a; padding:12px; margin:15px 0; font-weight:bold; text-align:center; color:#b36b00; border-radius:6px; box-shadow:0 0 5px rgba(255,212,42,0.5); font-size:1rem; }
  #tokoContainer { margin-top:10px; }
  #toggleOutputBtn { width:100%;padding:10px;margin-top:10px;margin-bottom:10px;border:none;border-radius:6px;background:#ffd42a;color:#b36b00;cursor:pointer;font-weight:bold; }
  #toggleOutputBtn:hover { background:#e6c72b; }
  #lastFetchInfo { font-size:0.9rem; color:#555; margin-top:4px; }
  @media (max-width:480px){
    h2,h3{ font-size:1rem; }
    textarea{ height:120px; font-size:0.9rem; }
    #output{ font-size:0.85rem; }
    .page-btn{ padding:8px 12px; font-size:0.9rem; }
    #copyBtn{ font-size:0.95rem; }
    .input-buttons{ flex-direction:column; }
    .input-buttons button{ flex:unset; width:100%; }
  }
</style>
</head>
<body>
<h2>Masukkan Link Shopee</h2>
<textarea id="inputLinks" placeholder="Masukkan ribuan link Shopee, satu per baris..."></textarea>
<div class="input-buttons">
  <button id="ambilLinksBtn">Ambil dari limabaru.txt</button>
  <button id="clearInputLinksBtn">Clear Input Links</button>
  <button id="copyInputLinksBtn">Copy Input Links</button>
</div>
<div id="lastFetchInfo">Terakhir update: -</div>

<div class="sponsor">Disponsori oleh <strong>Kios Tembakau MadGazan</strong></div>

<button id="toggleTokoBtn" style="width:100%;padding:10px;margin-bottom:10px;border:none;border-radius:6px;background:#ffd42a;color:#b36b00;cursor:pointer;font-weight:bold;">
  🔽 Sembunyikan ID Toko
</button>

<div id="tokoContainer">
  <h3>Masukkan ID Toko yang Dikecualikan (satu per baris)</h3>
  <textarea id="excludedShops" placeholder="Contoh: 123456789&#10;987654321"></textarea>
  <div class="input-buttons">
    <button id="ambilTokoBtn">Ambil dari data_toko.txt</button>
    <button id="clearInputTokoBtn">Clear Input Toko</button>
    <button id="copyInputTokoBtn">Copy Input Toko</button>
  </div>
</div>

<div id="stats"></div>

<h3>Output (maks 100 per halaman)</h3>
<button id="toggleOutputBtn">🔽 Sembunyikan Output Link</button>
<div id="output"></div>
<button id="copyBtn" onclick="copyToClipboard()">Copy Link di Halaman Ini</button>
<div class="pagination" id="pagination"></div>

<script>
let allLinks = [], currentPage = 1, maxPerPage = 100;
const inputLinksEl = document.getElementById('inputLinks');
const excludedShopsEl = document.getElementById('excludedShops');
const tokoContainer = document.getElementById('tokoContainer');
const toggleTokoBtn = document.getElementById('toggleTokoBtn');
const toggleOutputBtn = document.getElementById('toggleOutputBtn');
const outputDiv = document.getElementById('output');
const lastFetchInfo = document.getElementById('lastFetchInfo');
const pageKey = location.pathname.split('/').pop().replace(/\.[^/.]+$/,'');

toggleTokoBtn.addEventListener('click',()=>{
  const isHidden = tokoContainer.style.display==='none';
  if(isHidden){
    tokoContainer.style.display='block';
    toggleTokoBtn.innerHTML='🔽 Sembunyikan ID Toko';
    localStorage.setItem(`${pageKey}_showToko`, 'true');
  }else{
    tokoContainer.style.display='none';
    toggleTokoBtn.innerHTML='▶️ Tampilkan ID Toko';
    localStorage.setItem(`${pageKey}_showToko`, 'false');
  }
});

toggleOutputBtn.addEventListener('click',()=>{
  const isHidden = outputDiv.style.display==='none';
  if(isHidden){
    outputDiv.style.display='block';
    toggleOutputBtn.innerHTML='🔽 Sembunyikan Output Link';
    localStorage.setItem(`${pageKey}_showOutput`, 'true');
  }else{
    outputDiv.style.display='none';
    toggleOutputBtn.innerHTML='▶️ Tampilkan Output Link';
    localStorage.setItem(`${pageKey}_showOutput`, 'false');
  }
});

window.onload=()=>{
  if(localStorage.getItem(`${pageKey}_inputLinks`)) inputLinksEl.value=localStorage.getItem(`${pageKey}_inputLinks`);
  if(localStorage.getItem(`${pageKey}_excludedShops`)) excludedShopsEl.value=localStorage.getItem(`${pageKey}_excludedShops`);
  currentPage = parseInt(localStorage.getItem(`${pageKey}_lastPage`)) || 1;

  const showToko = localStorage.getItem(`${pageKey}_showToko`);
  if(showToko === 'false'){
    tokoContainer.style.display='none';
    toggleTokoBtn.innerHTML='▶️ Tampilkan ID Toko';
  }else{
    tokoContainer.style.display='block';
    toggleTokoBtn.innerHTML='🔽 Sembunyikan ID Toko';
  }

  const showOutput = localStorage.getItem(`${pageKey}_showOutput`);
  if(showOutput === 'false'){
    outputDiv.style.display='none';
    toggleOutputBtn.innerHTML='▶️ Tampilkan Output Link';
  }else{
    outputDiv.style.display='block';
    toggleOutputBtn.innerHTML='🔽 Sembunyikan Output Link';
  }

  processLinks();
  updateLastFetchDisplay();
};

document.getElementById('ambilLinksBtn').addEventListener('click',async ()=>{
  await manualFetchLimabaru();
});

async function manualFetchLimabaru(){
  try{
    const res=await fetch('limabarupria.txt?t='+Date.now(),{cache:'no-store'});
    if(!res.ok) throw new Error('HTTP '+res.status);
    const text=await res.text();
    const rows=text.split(/\r?\n/).map(r=>r.trim()).filter(Boolean);
    inputLinksEl.value=rows.join("\n");
    localStorage.setItem(`${pageKey}_inputLinks`,inputLinksEl.value);
    localStorage.setItem(`${pageKey}_lastFetchTime`, Date.now());
    processLinks();
    updateLastFetchDisplay();
  }catch(e){alert("Gagal mengambil limabaru.txt: "+e.message);}
}

document.getElementById('ambilTokoBtn').addEventListener('click',async ()=>{
  try{
    const res=await fetch('data_toko.txt?t='+Date.now(),{cache:'no-store'});
    if(!res.ok) throw new Error('HTTP '+res.status);
    const text=await res.text();
    const rows=text.split(/\r?\n/).map(r=>r.trim()).filter(Boolean);
    excludedShopsEl.value=rows.join("\n");
    localStorage.setItem(`${pageKey}_excludedShops`,excludedShopsEl.value);
    processLinks();
  }catch(e){alert("Gagal mengambil data_toko.txt: "+e.message);}
});

document.getElementById('clearInputLinksBtn').addEventListener('click',()=>{
  inputLinksEl.value='';
  localStorage.removeItem(`${pageKey}_inputLinks`);
  processLinks();
});
document.getElementById('copyInputLinksBtn').addEventListener('click',()=>{
  const text=inputLinksEl.value.trim();
  if(!text){alert("Input kosong!"); return;}
  navigator.clipboard.writeText(text).then(()=>alert("Isi input berhasil disalin!")).catch(()=>alert("Gagal menyalin!"));
});

document.getElementById('clearInputTokoBtn').addEventListener('click',()=>{
  excludedShopsEl.value='';
  localStorage.removeItem(`${pageKey}_excludedShops`);
  processLinks();
});
document.getElementById('copyInputTokoBtn').addEventListener('click',()=>{
  const text=excludedShopsEl.value.trim();
  if(!text){alert("Input kosong!"); return;}
  navigator.clipboard.writeText(text).then(()=>alert("Isi input berhasil disalin!")).catch(()=>alert("Gagal menyalin!"));
});

inputLinksEl.addEventListener('input',()=>{
  localStorage.setItem(`${pageKey}_inputLinks`,inputLinksEl.value);
  processLinks();
});
excludedShopsEl.addEventListener('input',()=>{
  localStorage.setItem(`${pageKey}_excludedShops`,excludedShopsEl.value);
  processLinks();
});

function processLinks(){
  const rawLines=inputLinksEl.value.split('\n').map(l=>l.trim());
  const excludedShopIds=excludedShopsEl.value.split('\n').map(id=>id.trim()).filter(Boolean);
  let pages=[], currentLinks=[];
  for(let i=0;i<rawLines.length;i++){
    const line=rawLines[i];
    if(line==='' || line==='###'){
      if(currentLinks.length>0){ pages.push(currentLinks); currentLinks=[]; }
    }else if(/\/product\/\d+\/\d+/.test(line)){
      const match=line.match(/\/product\/(\d+)\/\d+/);
      const shopId=match[1];
      if(!excludedShopIds.includes(shopId)) currentLinks.push(line);
      if(currentLinks.length>=maxPerPage){ pages.push(currentLinks); currentLinks=[]; }
    }
  }
  if(currentLinks.length>0) pages.push(currentLinks);
  allLinks=pages;

  const savedPage = parseInt(localStorage.getItem(`${pageKey}_lastPage`)) || 1;
  currentPage = Math.min(savedPage, allLinks.length) || 1;

  showPage(currentPage);
  renderPagination();

  const totalLinks=rawLines.filter(l=>l && l!=='###').length;
  document.getElementById('stats').textContent=`Total link diinput: ${totalLinks}\nTotal halaman: ${allLinks.length}`;
  outputDiv.style.display=allLinks.length?'block':'none';
}

function showPage(page){
  if(page<1||page>allLinks.length) return;
  const pageLinks=allLinks[page-1];
  outputDiv.innerHTML=pageLinks.map(l=>`<a href="${l}" target="_blank" rel="noopener noreferrer">${l}</a>`).join('');
  currentPage=page;
  localStorage.setItem(`${pageKey}_lastPage`, page);
  highlightActivePage();
}

function copyToClipboard(){
  if(!allLinks.length) return;
  const text=allLinks[currentPage-1].join('\n');
  navigator.clipboard.writeText(text).then(()=>alert(`Link di halaman ${currentPage} berhasil disalin!`)).catch(()=>alert('Gagal menyalin!'));
}

function renderPagination(){
  const pagination=document.getElementById('pagination');
  pagination.innerHTML='';
  for(let i=1;i<=allLinks.length;i++){
    const btn=document.createElement('button');
    btn.textContent=i;
    btn.className='page-btn';
    if(i===currentPage) btn.classList.add('active');
    btn.addEventListener('click',()=>showPage(i));
    pagination.appendChild(btn);
  }
}

function highlightActivePage(){
  document.querySelectorAll('.page-btn').forEach(btn=>{
    btn.classList.remove('active');
    if(parseInt(btn.textContent)===currentPage) btn.classList.add('active');
  });
}

// === Auto-refresh setiap 30 menit ===
const REFRESH_INTERVAL = 2 * 60 * 1000;
const LAST_FETCH_KEY = `${pageKey}_lastFetchTime`;

async function autoFetchLimabaru(){
  try{
    const res=await fetch('limabarupria.txt?t='+Date.now(),{cache:'no-store'});
    if(!res.ok) throw new Error('HTTP '+res.status);
    const text=await res.text();
    const rows=text.split(/\r?\n/).map(r=>r.trim()).filter(Boolean);
    inputLinksEl.value=rows.join("\n");
    localStorage.setItem(`${pageKey}_inputLinks`,inputLinksEl.value);
    localStorage.setItem(LAST_FETCH_KEY, Date.now());
    processLinks();
    updateLastFetchDisplay();
    console.log("✅ Auto-fetch berhasil:", new Date().toLocaleString());
  }catch(e){
    console.warn("❌ Gagal auto-fetch limabaru.txt:", e.message);
  }
}

function updateLastFetchDisplay(){
  const t=parseInt(localStorage.getItem(LAST_FETCH_KEY));
  if(!t){ lastFetchInfo.textContent="Terakhir update: belum pernah"; return; }
  const d=new Date(t);
  lastFetchInfo.textContent="Terakhir update: "+d.toLocaleString('id-ID');
}

window.addEventListener("load",()=>{
  const now=Date.now();
  const lastFetch=parseInt(localStorage.getItem(LAST_FETCH_KEY))||0;
  const elapsed=now-lastFetch;

  if(elapsed>=REFRESH_INTERVAL){
    autoFetchLimabaru();
  }else{
    const sisa=REFRESH_INTERVAL-elapsed;
    console.log(`⏳ Auto-fetch akan dijalankan dalam ${Math.round(sisa/60000)} menit`);
    setTimeout(autoFetchLimabaru,sisa);
  }
  setInterval(autoFetchLimabaru,REFRESH_INTERVAL);
});
</script>
</body>
</html>
