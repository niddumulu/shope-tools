<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Backup, Import & Filter Data MadGazan</title>
<style>
  body{font-family:Arial, sans-serif;margin:15px;max-width:900px;margin-inline:auto;background:#fffef9;color:#222}
  h1,h3{color:#b36b00;text-align:center}
  .section{padding:12px;background:#fffbe6;border-radius:8px;border:1px solid #ffd42a;margin-bottom:16px;text-align:center}
  button,input[type="file"],textarea{padding:8px 10px;font-size:0.95rem;border-radius:6px;border:1px solid #ccc;background:#f5f5f5;cursor:pointer}
  button:hover,input[type="file"]:hover,textarea:hover{background:#eee}
  textarea{width:100%;height:70px;resize:none;margin-top:8px;font-family:monospace}
  #toast{position:fixed;right:20px;bottom:20px;padding:12px 16px;border-radius:8px;color:#fff;opacity:0;transform:translateY(12px);transition:opacity .3s,transform .3s;z-index:9999}
  .output-wrap{background:#fff;padding:12px;border-radius:8px;border:1px solid #eee}
  .links-list{list-style:none;padding:0;margin:0}
  .links-list li{padding:8px 6px;border-bottom:1px solid #f0f0f0;display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  .link-anchor{color:#0066cc;text-decoration:none;word-break:break-all}
  .link-anchor:hover{text-decoration:underline}
  .meta{font-size:0.85rem;color:#666;white-space:nowrap}
  .controls{display:flex;gap:8px;flex-wrap:wrap;justify-content:center;margin-top:8px}
  .small{font-size:0.9rem;color:#444}
  .pager{display:flex;gap:8px;align-items:center;justify-content:center;margin-top:8px}
  .btn{padding:8px 10px;border-radius:6px;border:1px solid #ccc;background:#f5f5f5;cursor:pointer}
  .btn:hover{background:#eee}
  .danger{background:#ffd0d0;border-color:#cc0000}
  .success{background:#dff0df;border-color:#4CAF50}
  .info{background:#e8f4ff;border-color:#2196F3}
  .muted{color:#777;font-size:0.92rem}
  .flex{display:flex;gap:8px;align-items:center;justify-content:center;flex-wrap:wrap}
  @media (max-width:560px){ .meta{display:block} }
</style>
</head>
<body>

<h1>Backup, Import & Filter Data</h1>

<div class="section">
  <h3>üìÅ Import Universal</h3>
  <div class="flex">
    <input type="file" id="importFile" accept=".json">
    <button class="btn" onclick="importUniversal()">üì¶ Import Universal</button>
    <button class="btn" onclick="showAllData()">üìÑ Tampilkan Semua Data</button>
    <button id="restoreBtn" class="btn" style="display:none;" onclick="restoreBackup()">üîÅ Pulihkan Backup</button>
    <button class="btn danger" onclick="resetAllWithConfirm()">‚ùå Hapus Semua LocalStorage</button>
  </div>
  <div class="muted" style="margin-top:8px">Import file backup yang dihasilkan oleh sistem (format JSON key ‚Üí value).</div>
</div>

<div class="section">
  <h3>üßπ Filter / Hapus Berdasarkan ID Toko Shopee</h3>
  <div class="muted">Masukkan 1+ ID toko (pisah koma atau baris baru). Contoh: <code>968553125</code> atau <code>968553125,123456789</code></div>
  <textarea id="filterIds" placeholder="968553125, 123456789 atau tiap id per baris"></textarea>
  <div class="controls">
    <button class="btn" onclick="filterByStoreIds()">üö´ Filter & Hapus Link Toko</button>
    <button class="btn info" onclick="previewFilter()">üîé Preview Hapus (tanpa menyimpan)</button>
  </div>
  <div class="muted" id="filterNote" style="margin-top:8px">Sebelum filter: tidak ada backup yang tersimpan. Ketika filter dijalankan, backup otomatis disimpan di memori (tanpa auto-download).</div>
</div>

<div class="output-wrap">
  <div style="display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap">
    <div class="small">Hasil & Link (1 baris = 1 link)</div>
    <div id="stats" class="muted small"></div>
  </div>

  <ul id="linksList" class="links-list"></ul>

  <div class="pager" id="pager" style="display:none">
    <button class="btn" id="prevBtn" onclick="changePage(-1)">‚¨ÖÔ∏è Sebelumnya</button>
    <div id="pageInfo" class="muted small"></div>
    <button class="btn" id="nextBtn" onclick="changePage(1)">‚û°Ô∏è Berikutnya</button>
  </div>

  <div style="text-align:center;margin-top:10px">
    <button class="btn" onclick="downloadFilteredResult()" id="downloadFilteredBtn" style="display:none">‚¨áÔ∏è Download Hasil Filter (.txt)</button>
  </div>
</div>

<div id="toast"></div>

<script>
/* ===== Konfigurasi ===== */
const PER_PAGE = 99;

/* ===== State ===== */
let lastBackupData = null; // menyimpan backup sebelum filter (object)
let aggregatedLinks = []; // array { link, key }
let currentPage = 1;

/* ===== Toast ===== */
function showToast(msg, type='info'){
  const t = document.getElementById('toast');
  t.textContent = msg;
  let bg = '#2196F3';
  if(type==='success') bg='#4CAF50';
  if(type==='error') bg='#f44336';
  if(type==='warning') bg='#b36b00';
  t.style.background = bg;
  t.style.opacity = '1';
  t.style.transform = 'translateY(0)';
  setTimeout(()=>{ t.style.opacity='0'; t.style.transform='translateY(12px)'; },3500);
}

/* ===== Import Universal ===== */
function importUniversal(){
  const f = document.getElementById('importFile').files[0];
  if(!f) return showToast('‚ùå Pilih file JSON dulu.', 'error');
  const r = new FileReader();
  r.onload = e => {
    try{
      const data = JSON.parse(e.target.result);
      Object.keys(data).forEach(k => localStorage.setItem(k, data[k]));
      showToast('‚úÖ Import selesai.', 'success');
      setTimeout(showAllData,200);
    }catch(err){
      showToast('‚ùå File JSON tidak valid: ' + err.message, 'error');
    }
  };
  r.readAsText(f);
}

/* ===== Show All Data -> buat aggregatedLinks ===== */
function showAllData(){
  aggregatedLinks = collectAllLinksFromLocalStorage();
  currentPage = 1;
  renderPage();
  showToast(`‚úÖ Menampilkan semua link (${aggregatedLinks.length})`, 'success');
}

/* ===== Collect links from localStorage values (safe parsing) ===== */
function collectAllLinksFromLocalStorage(){
  const arr = [];
  for(let i=0;i<localStorage.length;i++){
    const key = localStorage.key(i);
    const val = localStorage.getItem(key);
    if(!val) continue;
    // coba parse json
    let parsed = null;
    try { parsed = JSON.parse(val); } catch(e){ parsed = null; }
    if(parsed && parsed.inputList && typeof parsed.inputList === 'string'){
      const lines = parsed.inputList.split('\n').map(s=>s.trim()).filter(Boolean);
      for(const ln of lines) arr.push({link:ln, key});
      continue;
    }
    // jika plain multiline text
    if(!parsed && val.includes('\n')){
      const lines = val.split('\n').map(s=>s.trim()).filter(Boolean);
      for(const ln of lines) arr.push({link:ln, key});
      continue;
    }
    // jika value tampak seperti single link atau id
    const single = val.trim();
    if(single && (single.startsWith('http') || /\d{5,}/.test(single))){
      arr.push({link: single, key});
    }
    // untuk nilai lain kita abaikan (agar aman)
  }
  return arr;
}

/* ===== Render pagination page ===== */
function renderPage(){
  const listEl = document.getElementById('linksList');
  listEl.innerHTML = '';
  const total = aggregatedLinks.length;
  if(total === 0){
    document.getElementById('stats').textContent = 'üì≠ Tidak ada link untuk ditampilkan.';
    document.getElementById('pager').style.display = 'none';
    document.getElementById('downloadFilteredBtn').style.display = 'none';
    return;
  }

  const totalPages = Math.max(1, Math.ceil(total / PER_PAGE));
  if(currentPage < 1) currentPage = 1;
  if(currentPage > totalPages) currentPage = totalPages;

  const start = (currentPage - 1) * PER_PAGE;
  const chunk = aggregatedLinks.slice(start, start + PER_PAGE);

  for(const item of chunk){
    const li = document.createElement('li');
    const a = document.createElement('a');
    a.href = item.link.startsWith('http') ? item.link : item.link;
    a.target = '_blank';
    a.className = 'link-anchor';
    a.textContent = item.link;
    const meta = document.createElement('span');
    meta.className = 'meta';
    meta.textContent = item.key;
    li.appendChild(a);
    li.appendChild(meta);
    listEl.appendChild(li);
  }

  document.getElementById('stats').textContent = `Total link: ${total} ‚Ä¢ Halaman ${currentPage} / ${totalPages}`;
  document.getElementById('pager').style.display = totalPages > 1 ? 'flex' : 'none';
  document.getElementById('pageInfo').textContent = `Menampilkan ${start+1}‚Äì${Math.min(start+chunk.length,total)} dari ${total}`;
  document.getElementById('downloadFilteredBtn').style.display = total ? 'inline-block' : 'none';
}

/* ===== Change page ===== */
function changePage(delta){
  currentPage += delta;
  renderPage();
}

/* ===== Preview Filter (hanya hitung tanpa ubah storage) ===== */
function previewFilter(){
  const ids = parseIdsInput();
  if(ids.length === 0) return showToast('‚ö†Ô∏è Masukkan minimal 1 ID toko untuk preview.', 'warning');
  const links = collectAllLinksFromLocalStorage();
  const willRemove = [];
  for(const item of links){
    for(const id of ids){
      if(matchLineContainsId(item.link, id)){
        willRemove.push(item);
        break;
      }
    }
  }
  showToast(`üîé Preview: ${willRemove.length} link akan dihapus jika menjalankan filter.`, 'info');
  // tampilkan preview list (temporary)
  aggregatedLinks = links.filter(li => !willRemove.includes(li));
  currentPage = 1;
  renderPage();
}

/* ===== Parse IDs from textarea ===== */
function parseIdsInput(){
  const raw = document.getElementById('filterIds').value.trim();
  if(!raw) return [];
  const parts = raw.split(/[\n,;]+/).map(s=>s.trim()).filter(Boolean);
  // normalize: keep digits only, require at least 5 digits to reduce false positive
  const ids = [];
  for(const p of parts){
    const digits = p.replace(/\D/g,'');
    if(digits.length >= 5) ids.push(digits);
  }
  // unique
  return Array.from(new Set(ids));
}

/* ===== Matching helper: decide if a line contains the shop id as product/{id} or word boundary ===== */
function matchLineContainsId(line, id){
  if(!line) return false;
  const lower = line.toLowerCase();
  // check product/{id}/ or product/{id}
  if(lower.includes(`/product/${id}/`) || lower.includes(`/product/${id}`)) return true;
  // or standalone number word
  const wordNum = new RegExp(`\\b${id}\\b`);
  return wordNum.test(line);
}

/* ===== Filter & apply to localStorage (safe) ===== */
function filterByStoreIds(){
  const ids = parseIdsInput();
  if(ids.length === 0) return showToast('‚ö†Ô∏è Masukkan minimal 1 ID toko.', 'warning');

  // backup in-memory (no download)
  lastBackupData = {};
  for(let i=0;i<localStorage.length;i++){
    const k = localStorage.key(i);
    lastBackupData[k] = localStorage.getItem(k);
  }
  document.getElementById('restoreBtn').style.display = 'inline-block';
  document.getElementById('filterNote').textContent = 'Backup tersimpan di memori. Gunakan "Pulihkan Backup" jika ingin rollback.';

  // stats
  let totalKeysChecked = 0;
  let totalKeysUpdated = 0;
  let totalKeysRemoved = 0;
  let totalLinesRemoved = 0;

  // collect keys first to avoid mutation during iteration
  const keys = [];
  for(let i=0;i<localStorage.length;i++) keys.push(localStorage.key(i));

  const newStorage = {}; // we'll build new storage then write (to avoid partial issues)

  for(const key of keys){
    totalKeysChecked++;
    const raw = localStorage.getItem(key);
    if(!raw){
      continue;
    }

    // try parse JSON
    let parsed = null;
    let isJson = false;
    try { parsed = JSON.parse(raw); isJson = true; } catch(e){ isJson = false; }

    if(isJson && parsed && typeof parsed === 'object' && typeof parsed.inputList === 'string'){
      const lines = parsed.inputList.split('\n').map(s=>s.trim()).filter(Boolean);
      const retained = [];
      for(const line of lines){
        let shouldRemove = false;
        for(const id of ids){ if(matchLineContainsId(line, id)){ shouldRemove = true; break; } }
        if(!shouldRemove) retained.push(line); else totalLinesRemoved++;
      }
      if(retained.length === 0){
        totalKeysRemoved++;
        // do not put this key into newStorage
      } else {
        parsed.inputList = retained.join('\n');
        newStorage[key] = JSON.stringify(parsed);
        totalKeysUpdated++;
      }
      continue;
    }

    // if plain multiline text
    if(!isJson && raw.includes('\n')){
      const lines = raw.split('\n').map(s=>s.trim()).filter(Boolean);
      const retained = [];
      for(const line of lines){
        let shouldRemove = false;
        for(const id of ids){ if(matchLineContainsId(line, id)){ shouldRemove = true; break; } }
        if(!shouldRemove) retained.push(line); else totalLinesRemoved++;
      }
      if(retained.length === 0){
        totalKeysRemoved++;
      } else {
        newStorage[key] = retained.join('\n');
        totalKeysUpdated++;
      }
      continue;
    }

    // other values (single line) - keep as-is
    newStorage[key] = raw;
  }

  // write newStorage: clear then set
  localStorage.clear();
  Object.keys(newStorage).forEach(k => localStorage.setItem(k, newStorage[k]));

  // update aggregated list and UI
  aggregatedLinks = collectAllLinksFromLocalStorage();
  currentPage = 1;
  renderPage();

  showToast(`‚úÖ Filter selesai. Keys dicek:${totalKeysChecked} ‚Ä¢ diupdate:${totalKeysUpdated} ‚Ä¢ dihapus:${totalKeysRemoved} ‚Ä¢ link dihapus:${totalLinesRemoved}`, 'success');
}

/* ===== Restore backup (in-memory) ===== */
function restoreBackup(){
  if(!lastBackupData) return showToast('‚ùå Tidak ada backup tersedia.', 'error');
  if(!confirm('Pulihkan backup yang tersimpan di memori? Ini akan mengganti seluruh localStorage saat ini.')) return;
  localStorage.clear();
  Object.keys(lastBackupData).forEach(k => localStorage.setItem(k, lastBackupData[k]));
  lastBackupData = null;
  document.getElementById('restoreBtn').style.display = 'none';
  document.getElementById('filterNote').textContent = 'Tidak ada backup tersimpan.';
  showAllData();
  showToast('üîÅ Backup dipulihkan.', 'success');
}

/* ===== Reset all with confirm ===== */
function resetAllWithConfirm(){
  if(!confirm('Yakin ingin menghapus seluruh localStorage? Tindakan ini permanen.')) return;
  localStorage.clear();
  aggregatedLinks = [];
  renderPage();
  showToast('‚ö†Ô∏è Semua localStorage telah dihapus.', 'warning');
}

/* ===== Download filtered result as .txt (all links aggregated) ===== */
function downloadFilteredResult(){
  // aggregate current displayed full list (not only page): aggregatedLinks
  if(!aggregatedLinks || aggregatedLinks.length===0) return showToast('‚ùå Tidak ada link untuk di-download.','error');
  const lines = aggregatedLinks.map(i => i.link);
  const blob = new Blob([lines.join('\n')], {type:'text/plain;charset=utf-8'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = 'filtered_links.txt';
  a.click();
  URL.revokeObjectURL(url);
}

/* ===== Init: show current data on load (but don't flood) ===== */
window.addEventListener('load', () => {
  // do not auto-show; show only if there's data ‚Äî safer
  if(localStorage.length > 0){
    // prepare aggregated list but don't render automatically to avoid UI flash
    aggregatedLinks = collectAllLinksFromLocalStorage();
    // only render first page if there are links
    if(aggregatedLinks.length > 0) renderPage();
  }
});
</script>

</body>
</html>