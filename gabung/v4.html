<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Backup & Import Data MadGazan</title>
<style>
  body { 
    font-family: Arial, sans-serif; 
    margin: 15px; 
    max-width: 600px; 
    margin-inline:auto; 
    background-color:#fffef9; 
  }
  h1,h2,h3 { color:#b36b00; text-align:center; }
  h1 { font-size:1.6rem; margin-bottom:5px; }
  .backup-area { 
    padding:12px; 
    background:#fffbe6; 
    border-radius:8px; 
    border:1px solid #ffd42a; 
    text-align:center; 
  }
  .input-buttons { 
    display:flex; 
    gap:8px; 
    margin-top:6px; 
    flex-wrap:wrap; 
    justify-content:center; 
  }
  .input-buttons button, .input-buttons input[type="file"] { 
    flex:1; 
    padding:10px; 
    font-size:0.95rem; 
    cursor:pointer; 
    border:1px solid #ccc; 
    border-radius:6px; 
    background:#f5f5f5; 
  }
  .input-buttons button:hover { background:#eee; }
  .display-area button:hover { background:#d0f0f5; }
  #toast {
    position: fixed; bottom: 25px; right: 25px; 
    padding: 12px 20px; border-radius: 8px; 
    box-shadow: 0 2px 10px rgba(0,0,0,0.3); 
    opacity: 0; transform: translateY(20px); 
    transition: opacity 0.4s, transform 0.4s; 
    z-index: 9999; max-width: 320px; white-space: pre-line; 
    line-height:1.3; font-size:0.95rem; color:#fff;
  }
  pre { font-family: monospace; }
</style>
</head>
<body>

<h1>Backup & Import Data</h1>

<div class="backup-area">
  <h3>üîí Backup & Import Data LocalStorage</h3>
  <div class="input-buttons">
    <button onclick="exportLocalStorage()">Backup Data ke File</button>
    <button onclick="exportLocalStorageClean()">Backup Data (Tanpa Duplikat)</button>
    <input type="file" id="importFile" accept=".json">
    <button onclick="importLocalStorage()">Import Data</button>
    <!-- üîΩ Tombol baru universal -->
    <button onclick="exportUniversalLocal()">Backup Universal (Halaman Ini)</button>
    <button onclick="importUniversalLocal()">Import Universal</button>
  </div>
  <button style="margin-top:10px; background:#ffd0d0; border-color:#cc0000;" onclick="resetLocalStorage()">‚ùå Hapus Semua Data Halaman Ini</button>
</div>

<div class="display-area" style="margin-top:20px; text-align:center;">
  <button onclick="showLocalStorageData()" style="padding:10px 16px; font-size:0.95rem; border-radius:6px; border:1px solid #ccc; background:#e0f7fa; cursor:pointer;">
    üìÑ Tampilkan Data LocalStorage Halaman Ini
  </button>
  <pre id="localData" style="text-align:left; margin-top:12px; padding:10px; background:#f9f9f9; border:1px solid #ddd; border-radius:6px; max-height:300px; overflow:auto;"></pre>
</div>

<div id="toast"></div>

<script>
/* ===== Prefix Unik Berdasarkan Nama Halaman ===== */
const PAGE_PREFIX = location.pathname.split('/').pop().replace('.html','') + '_';

/* ===== Toast Notification ===== */
function showToast(message, type='info') {
  const toast = document.getElementById('toast');
  toast.textContent = message;
  let bgColor = '#333';
  if(type === 'success') bgColor = '#4CAF50';
  if(type === 'error') bgColor = '#f44336';
  if(type === 'warning') bgColor = '#b36b00';
  if(type === 'info') bgColor = '#2196F3';
  toast.style.background = bgColor;
  toast.style.opacity = '1';
  toast.style.transform = 'translateY(0)';
  setTimeout(() => {
    toast.style.opacity = '0';
    toast.style.transform = 'translateY(20px)';
  }, 4000);
}

/* ===== Backup & Import Universal ===== */
function exportLocalStorage() {
  const data = {};
  for (let i = 0; i < localStorage.length; i++) {
    const key = localStorage.key(i);
    data[key] = localStorage.getItem(key);
  }
  const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = 'madgazan_backup_all.json';
  a.click();
  URL.revokeObjectURL(url);
  showToast('‚úÖ Backup semua data berhasil disimpan.', 'success');
}

function exportLocalStorageClean() {
  const cleanedData = {};
  let totalRemoved = 0;
  for (let i = 0; i < localStorage.length; i++) {
    const key = localStorage.key(i);
    const value = localStorage.getItem(key);
    try {
      const parsed = JSON.parse(value);
      if (parsed && parsed.inputList) {
        const lines = parsed.inputList.split('\n').map(l => l.trim()).filter(Boolean);
        const unique = [...new Set(lines)];
        totalRemoved += lines.length - unique.length;
        cleanedData[key] = JSON.stringify({ ...parsed, inputList: unique.join('\n') });
      } else {
        cleanedData[key] = value;
      }
    } catch {
      cleanedData[key] = value;
    }
  }
  const blob = new Blob([JSON.stringify(cleanedData, null, 2)], { type: 'application/json' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = 'madgazan_backup_clean.json';
  a.click();
  URL.revokeObjectURL(url);
  showToast(`‚úÖ Backup bersih selesai!\nDuplikat dihapus: ${totalRemoved}`, 'success');
}

function importLocalStorage() {
  const fileInput = document.getElementById('importFile');
  const file = fileInput.files[0];
  if (!file) return showToast('‚ùå Pilih file JSON dulu.', 'error');
  const reader = new FileReader();
  reader.onload = e => {
    try {
      const data = JSON.parse(e.target.result);
      Object.keys(data).forEach(key => localStorage.setItem(key, data[key]));
      showToast('‚úÖ Data berhasil diimport.\nReload halaman untuk melihat hasil.', 'success');
      setTimeout(() => location.reload(), 1500);
    } catch (err) {
      showToast('‚ùå File tidak valid: ' + err.message, 'error');
    }
  };
  reader.readAsText(file);
}

/* ===== Reset hanya data halaman ini ===== */
function resetLocalStorage() {
  if (confirm('Yakin ingin menghapus semua data halaman ini saja?')) {
    const toDelete = [];
    for (let i = 0; i < localStorage.length; i++) {
      const key = localStorage.key(i);
      if (key.startsWith(PAGE_PREFIX)) toDelete.push(key);
    }
    toDelete.forEach(k => localStorage.removeItem(k));
    showToast('‚ö†Ô∏è Semua data halaman ini telah dihapus.', 'warning');
    setTimeout(() => location.reload(), 1000);
  }
}

/* ===== Tampilkan hanya data halaman ini ===== */
function showLocalStorageData() {
  const display = document.getElementById('localData');
  const data = {};
  for (let i = 0; i < localStorage.length; i++) {
    const key = localStorage.key(i);
    if (key.startsWith(PAGE_PREFIX)) data[key] = localStorage.getItem(key);
  }
  display.textContent = Object.keys(data).length
    ? JSON.stringify(data, null, 2)
    : 'üì≠ LocalStorage halaman ini kosong.';
  showToast('‚úÖ Data halaman ini berhasil ditampilkan.', 'success');
}

/* ===== UNIVERSAL BACKUP SISTEM (v2) ===== */
// Backup hanya data unik halaman ini ‚Üí untuk dibagikan ke halaman lain
function exportUniversalLocal() {
  const data = {};
  for (let i = 0; i < localStorage.length; i++) {
    const key = localStorage.key(i);
    if (key.startsWith(PAGE_PREFIX)) data[key] = localStorage.getItem(key);
  }
  if (Object.keys(data).length === 0) return showToast('üì≠ Tidak ada data halaman ini untuk dibackup.', 'warning');
  
  const blob = new Blob([JSON.stringify({ origin: PAGE_PREFIX, data }, null, 2)], { type: 'application/json' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `madgazan_backup_${PAGE_PREFIX}.json`;
  a.click();
  URL.revokeObjectURL(url);
  showToast('‚úÖ Backup halaman ini (universal) berhasil.', 'success');
}

// Import universal ‚Üí bisa menerima file dari halaman mana pun
function importUniversalLocal() {
  const fileInput = document.getElementById('importFile');
  const file = fileInput.files[0];
  if (!file) return showToast('‚ùå Pilih file JSON dulu.', 'error');
  const reader = new FileReader();
  reader.onload = e => {
    try {
      const json = JSON.parse(e.target.result);
      const imported = json.data ? json.data : json; // mendukung format lama & baru
      let count = 0;
      Object.entries(imported).forEach(([key, val]) => {
        localStorage.setItem(key, val);
        count++;
      });
      showToast(`‚úÖ Import universal selesai.\nTotal data masuk: ${count}`, 'success');
      setTimeout(() => location.reload(), 1500);
    } catch (err) {
      showToast('‚ùå File tidak valid: ' + err.message, 'error');
    }
  };
  reader.readAsText(file);
}
</script>

</body>
</html>