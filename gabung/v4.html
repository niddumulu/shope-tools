<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Filter Toko Shopee - MadGazan</title>
<style>
  body{font-family:Arial, sans-serif;margin:15px;max-width:900px;margin-inline:auto;background:#fffef9;color:#222}
  h1,h3{color:#b36b00;text-align:center}
  .card{padding:12px;background:#fffbe6;border-radius:8px;border:1px solid #ffd42a;margin-bottom:16px;text-align:center}
  button, textarea, input{padding:8px 10px;font-size:0.95rem;border-radius:6px;border:1px solid #ccc;background:#f5f5f5;cursor:pointer}
  textarea{width:100%;height:70px;resize:none;margin-top:8px;font-family:monospace}
  button:hover,textarea:hover,input:hover{background:#eee}
  #toast{position:fixed;right:20px;bottom:20px;padding:12px 16px;border-radius:8px;color:#fff;opacity:0;transform:translateY(12px);transition:opacity .3s,transform .3s;z-index:9999}
  .output{background:#fff;padding:12px;border-radius:8px;border:1px solid #eee}
  .links{list-style:none;padding:0;margin:0}
  .links li{padding:8px 6px;border-bottom:1px solid #f0f0f0;display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  .link-a{color:#0066cc;text-decoration:none;word-break:break-all}
  .link-a:hover{text-decoration:underline}
  .meta{font-size:0.85rem;color:#666;white-space:nowrap}
  .pager{display:flex;gap:8px;align-items:center;justify-content:center;margin-bottom:10px}
  .btn{padding:8px 10px;border-radius:6px;border:1px solid #ccc;background:#f5f5f5;cursor:pointer}
  .btn:hover{background:#eee}
  .danger{background:#ffd0d0;border-color:#cc0000}
  .info{background:#e8f4ff;border-color:#2196F3}
  .muted{color:#777;font-size:0.92rem}
  @media (max-width:560px){ .meta{display:block} }
</style>
</head>
<body>

<h1>Filter / Hapus Berdasarkan ID Toko Shopee</h1>

<div class="card">
  <div class="muted">Masukkan satu atau beberapa ID toko (pisah koma atau baris baru). Contoh: <code>968553125</code> atau <code>968553125,123456789</code></div>
  <textarea id="idsInput" placeholder="968553125, 123456789 atau tiap id per baris"></textarea>
  <div style="margin-top:10px;display:flex;gap:8px;justify-content:center;flex-wrap:wrap">
    <button class="btn" id="filterBtn" onclick="applyFilter()">üö´ Filter & Hapus Link Toko</button>
    <button class="btn info" onclick="previewFilter()">üîé Preview Hapus (tanpa menyimpan)</button>
    <button class="btn" id="undoBtn" style="display:none" onclick="restoreBackup()">üîÅ Pulihkan (Undo)</button>
  </div>
  <div class="muted" id="note" style="margin-top:8px">Operasi akan menyimpan backup sementara di memori (bisa di-undo selama halaman belum direload).</div>
</div>

<div class="output">
  <div id="pagerTop" style="display:none" class="pager">
    <button class="btn" onclick="changePage(-1)" id="prevBtn">‚¨ÖÔ∏è Sebelumnya</button>
    <div id="pageInfo" class="muted"></div>
    <button class="btn" onclick="changePage(1)" id="nextBtn">‚û°Ô∏è Berikutnya</button>
  </div>

  <ul id="linksUL" class="links"></ul>

  <div style="text-align:center;margin-top:8px">
    <div id="stats" class="muted"></div>
  </div>
</div>

<div id="toast"></div>

<script>
/* konfigurasi */
const PER_PAGE = 99;

/* state */
let lastBackupData = null;
let aggregated = []; // {link, key}
let page = 1;

/* toast */
function showToast(msg, type='info'){
  const t = document.getElementById('toast');
  t.textContent = msg;
  let bg = '#2196F3';
  if(type==='success') bg='#4CAF50';
  if(type==='error') bg='#f44336';
  if(type==='warning') bg='#b36b00';
  t.style.background = bg;
  t.style.opacity = '1';
  t.style.transform = 'translateY(0)';
  setTimeout(()=>{ t.style.opacity='0'; t.style.transform='translateY(12px)'; },3500);
}

/* collect links from localStorage */
function collectLinks(){
  const list = [];
  for(let i=0;i<localStorage.length;i++){
    const key = localStorage.key(i);
    const raw = localStorage.getItem(key);
    if(!raw) continue;
    // try parse JSON
    let parsed=null;
    try{ parsed = JSON.parse(raw); } catch(e){ parsed = null; }
    if(parsed && parsed.inputList && typeof parsed.inputList === 'string'){
      const lines = parsed.inputList.split('\n').map(s=>s.trim()).filter(Boolean);
      for(const l of lines) list.push({link:l, key});
      continue;
    }
    if(!parsed && raw.includes('\n')){
      const lines = raw.split('\n').map(s=>s.trim()).filter(Boolean);
      for(const l of lines) list.push({link:l, key});
      continue;
    }
    // single-value case
    const single = raw.trim();
    if(single && (single.startsWith('http') || /\d{5,}/.test(single))){
      list.push({link: single, key});
    }
  }
  return list;
}

/* render page (pagination above results) */
function render(){
  const ul = document.getElementById('linksUL');
  ul.innerHTML = '';
  const total = aggregated.length;
  const totalPages = Math.max(1, Math.ceil(total / PER_PAGE));
  if(page < 1) page = 1;
  if(page > totalPages) page = totalPages;

  // show/hide pager
  const pager = document.getElementById('pagerTop');
  if(total > 0) pager.style.display = 'flex'; else pager.style.display = 'none';

  const start = (page -1) * PER_PAGE;
  const chunk = aggregated.slice(start, start + PER_PAGE);
  for(const it of chunk){
    const li = document.createElement('li');
    const a = document.createElement('a');
    a.href = it.link.startsWith('http') ? it.link : it.link;
    a.target = '_blank';
    a.className = 'link-a';
    a.textContent = it.link;
    const meta = document.createElement('span');
    meta.className = 'meta';
    meta.textContent = it.key;
    li.appendChild(a);
    li.appendChild(meta);
    ul.appendChild(li);
  }

  document.getElementById('pageInfo').textContent = total===0 ? 'Tidak ada link' : `Menampilkan ${Math.min(start+1,total)}‚Äì${Math.min(start+chunk.length,total)} dari ${total} ‚Ä¢ Halaman ${page}/${totalPages}`;
  document.getElementById('stats').textContent = total===0 ? '' : `Total link: ${total}`;
}

/* change page */
function changePage(delta){
  page += delta;
  render();
}

/* helper: parse IDs input */
function parseIds(){
  const raw = document.getElementById('idsInput').value.trim();
  if(!raw) return [];
  const parts = raw.split(/[\n,;]+/).map(s=>s.trim()).filter(Boolean);
  const ids = [];
  for(const p of parts){
    const digits = p.replace(/\D/g,'');
    if(digits.length >= 5) ids.push(digits);
  }
  return Array.from(new Set(ids));
}

/* match line contains id: product/{id}/ or product/{id} or standalone word */
function matchContains(line, id){
  if(!line) return false;
  const l = line.toLowerCase();
  if(l.includes(`/product/${id}/`) || l.includes(`/product/${id}`)) return true;
  const re = new RegExp(`\\b${id}\\b`);
  return re.test(line);
}

/* preview filter: show what remains without changing storage */
function previewFilter(){
  const ids = parseIds();
  if(ids.length === 0) return showToast('‚ö†Ô∏è Masukkan minimal 1 ID toko untuk preview.', 'warning');
  const all = collectLinks();
  // compute remaining
  const removed = new Set();
  const remaining = [];
  for(const it of all){
    let rm=false;
    for(const id of ids){ if(matchContains(it.link, id)){ rm=true; break; } }
    if(!rm) remaining.push(it);
  }
  aggregated = remaining;
  page = 1;
  render();
  showToast(`üîé Preview: ${all.length - remaining.length} link akan dihapus (preview).`, 'info');
}

/* main apply filter (with in-memory backup and undo) */
function applyFilter(){
  const ids = parseIds();
  if(ids.length === 0) return showToast('‚ö†Ô∏è Masukkan minimal 1 ID toko.', 'warning');

  // backup in-memory
  lastBackupData = {};
  for(let i=0;i<localStorage.length;i++){
    const k = localStorage.key(i);
    lastBackupData[k] = localStorage.getItem(k);
  }
  document.getElementById('undoBtn').style.display = 'inline-block';
  document.getElementById('note').textContent = 'Backup disimpan di memori ‚Äî gunakan Pulihkan (Undo) jika perlu.';

  // iterate keys safely
  const keys = [];
  for(let i=0;i<localStorage.length;i++) keys.push(localStorage.key(i));

  const newStore = {};
  let totalLinesRemoved = 0;
  let keysUpdated = 0;
  let keysRemoved = 0;

  for(const key of keys){
    const raw = localStorage.getItem(key);
    if(!raw){ continue; }

    // try JSON with inputList
    let parsed=null;
    let isJson=false;
    try{ parsed = JSON.parse(raw); isJson=true; } catch(e){ isJson=false; parsed=null; }

    if(isJson && parsed && typeof parsed.inputList === 'string'){
      const lines = parsed.inputList.split('\n').map(s=>s.trim()).filter(Boolean);
      const kept = [];
      for(const ln of lines){
        let rm=false;
        for(const id of ids){ if(matchContains(ln, id)){ rm=true; break; } }
        if(!rm) kept.push(ln); else totalLinesRemoved++;
      }
      if(kept.length === 0){
        keysRemoved++;
      } else {
        parsed.inputList = kept.join('\n');
        newStore[key] = JSON.stringify(parsed);
        keysUpdated++;
      }
      continue;
    }

    // if plain multiline
    if(!isJson && raw.includes('\n')){
      const lines = raw.split('\n').map(s=>s.trim()).filter(Boolean);
      const kept = [];
      for(const ln of lines){
        let rm=false;
        for(const id of ids){ if(matchContains(ln, id)){ rm=true; break; } }
        if(!rm) kept.push(ln); else totalLinesRemoved++;
      }
      if(kept.length === 0){
        keysRemoved++;
      } else {
        newStore[key] = kept.join('\n');
        keysUpdated++;
      }
      continue;
    }

    // other single values -> keep as is
    newStore[key] = raw;
  }

  // write newStore
  localStorage.clear();
  Object.keys(newStore).forEach(k => localStorage.setItem(k, newStore[k]));

  // update aggregated and UI
  aggregated = collectLinks();
  page = 1;
  render();

  showToast(`‚úÖ Filter selesai. Keys diperbarui: ${keysUpdated}, Keys dihapus: ${keysRemoved}, Link dihapus: ${totalLinesRemoved}`, 'success');
}

/* restore backup (undo) */
function restoreBackup(){
  if(!lastBackupData) return showToast('‚ùå Tidak ada backup di memori.', 'error');
  if(!confirm('Pulihkan backup? Ini akan mengganti seluruh localStorage saat ini.')) return;
  localStorage.clear();
  Object.keys(lastBackupData).forEach(k => localStorage.setItem(k, lastBackupData[k]));
  lastBackupData = null;
  document.getElementById('undoBtn').style.display = 'none';
  document.getElementById('note').textContent = 'Backup dipulihkan / tidak ada backup tersimpan.';
  aggregated = collectLinks();
  page = 1;
  render();
  showToast('üîÅ Backup dipulihkan.', 'success');
}

/* init: prepare aggregated but don't force preview; only show if there are links */
window.addEventListener('load', () => {
  aggregated = collectLinks();
  if(aggregated.length>0) render();
});
</script>
</body>
</html>