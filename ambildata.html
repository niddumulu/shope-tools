<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <title>Baca CSV Kolom P & Data TXT</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; max-width: 700px; }
    textarea { width: 100%; height: 200px; margin-top: 10px; }
    button { margin: 5px 5px 5px 0; padding: 8px 15px; font-size: 14px; cursor: pointer; }
  </style>
</head>
<body>
  <h2>Upload Multi CSV atau Ambil dari data.txt</h2>

  <div>
    <input type="file" id="csvFile" accept=".csv" multiple>
    <button onclick="processCSV()">Upload & Proses CSV</button>
  </div>

  <div>
    <button onclick="ambilTXT()">Ambil dari data.txt</button>
  </div>

  <p id="status"></p>
  <textarea id="output" readonly></textarea><br>
  <button onclick="copyData()" id="copyBtn" style="display:none;">Copy</button>

  <script>
    function processCSV() {
      const fileInput = document.getElementById("csvFile");
      const files = fileInput.files;
      if (!files.length) {
        alert("Pilih minimal satu file CSV!");
        return;
      }

      let allResults = [];
      let filesProcessed = 0;

      Array.from(files).forEach(file => {
        const reader = new FileReader();
        reader.onload = function(e) {
          const text = e.target.result;
          const rows = text.split(/\r?\n/).filter(r => r.trim() !== "");
          if (rows.length > 1) {
            for (let i = 1; i < rows.length; i++) { // skip header
              const cols = rows[i].split(",");
              if (cols.length > 15 && cols[15].trim() !== "") { 
                let val = cols[15].trim();
                val = val.replace(/^"|"$/g, ''); // hilangkan tanda petik
                allResults.push(val);
              }
            }
          }
          filesProcessed++;
          if (filesProcessed === files.length) {
            tampilkanHasil(allResults);
          }
        };
        reader.readAsText(file);
      });
    }

    function ambilTXT() {
      const url = "data.txt?t=" + new Date().getTime(); // bypass cache
      fetch(url, { cache: "no-store" })
        .then(response => {
          if (!response.ok) throw new Error("Gagal ambil data.txt");
          return response.text();
        })
        .then(text => {
          const rows = text.split(/\r?\n/).filter(r => r.trim() !== "");
          let result = rows.map(r => r.replace(/^"|"$/g, '')); // bersihkan petik
          tampilkanHasil(result);
        })
        .catch(err => {
          alert("Error: " + err.message);
        });
    }

    function tampilkanHasil(result) {
      document.getElementById("output").value = result.join("\n");
      document.getElementById("status").innerText =
        "Sudah terupload " + result.length + " data.";
      document.getElementById("copyBtn").style.display = "inline-block";
    }

    function copyData() {
      const textarea = document.getElementById("output");
      textarea.select();
      textarea.setSelectionRange(0, 99999); // untuk mobile
      document.execCommand("copy");
      alert("Data berhasil dicopy!");
    }
  </script>
</body>
</html>
